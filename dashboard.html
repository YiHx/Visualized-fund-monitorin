<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­é«˜å‡€å€¼èµ„äº§ | LP ç›‘æ§å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>.neon-text { text-shadow: 0 0 10px rgba(52, 211, 153, 0.5); } body { background-color: #0f172a; color: #f8fafc; }</style>
</head>
<body class="p-4 md:p-8 font-mono">

<div id="app" class="max-w-4xl mx-auto space-y-6">
    <header class="border-b border-gray-700 pb-4 flex justify-between items-end">
        <div>
            <h1 class="text-2xl font-bold text-gray-200 tracking-widest">åº•å±‚èµ„äº§å‡€å€¼ç›‘æ§ (LPç«¯)</h1>
            <p class="text-sm text-gray-400 mt-1">ä¹™æ–¹ä»…äº«æœ‰å‡€æœ¬é‡‘å®‰å…¨æƒåŠè¢«åŠ¨æ”¶ç›Šæƒ [cite: 4]</p>
        </div>
    </header>

    <div v-if="limitStatus.can_claim_quarterly" class="bg-blue-900/40 border border-blue-500 p-5 rounded-lg flex flex-col md:flex-row justify-between items-center shadow-lg shadow-blue-900/20">
        <div class="mb-4 md:mb-0">
            <h3 class="text-blue-400 font-bold text-lg mb-1">ğŸ”” å­£åº¦æµåŠ¨æ€§æ´¾å‘è®¸å¯ (ç”±ä½ æŠ‰æ‹©)</h3>
            <p class="text-sm text-blue-200 leading-relaxed">
                GP å·²ä¸‹è¾¾æœ¬å­£åº¦ 30 å…ƒå…å®¡æå–è®¸å¯ã€‚è¿™æ˜¯ä¸€é“é€‰æ‹©é¢˜ï¼š<br>
                ğŸ‘‰ ä½ å¯ä»¥é€‰æ‹© <span class="font-bold text-white">æå–ç°é’</span>ï¼ˆèµ„é‡‘å°†ç¦»å¼€æœ¬ç³»ç»Ÿï¼Œä½ å°†ä¸§å¤±è¿™30å…ƒåœ¨æœªæ¥çš„æ— é™å¤åˆ©ï¼‰ã€‚<br>
                ğŸ‘‰ æˆ–è€…é€‰æ‹© <span class="font-bold text-white">å¿½ç•¥æ­¤é€šçŸ¥</span>ï¼ˆè®©èµ„é‡‘ç•™åœ¨æ± å­é‡Œï¼Œç»§ç»­ä¸ºä½ æ‰“å·¥èµšé’±ï¼‰ã€‚
            </p>
        </div>
        <button @click="claimQuarterly" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded shadow-lg transition whitespace-nowrap">
            æå–ç°é’ (è½è¢‹ä¸ºå®‰)
        </button>
    </div>

    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <div class="flex justify-between text-sm mb-2">
            <span class="text-gray-400">æœ¬æœˆåŠ¨æ€é…é¢é˜ˆå€¼ (å·²å«é€šèƒ€ä¸Šæµ®): <span class="text-white">Â¥{{ limitStatus.monthly_limit }}</span></span>
            <span :class="limitStatus.remaining < 20 ? 'text-red-400' : 'text-emerald-400'">å‰©ä½™å¯æ: Â¥{{ limitStatus.remaining }}</span>
        </div>
        <div class="w-full bg-gray-900 rounded-full h-2.5">
            <div class="bg-blue-600 h-2.5 rounded-full" :style="`width: ${Math.min((limitStatus.used_amount / limitStatus.monthly_limit) * 100, 100)}%`"></div>
        </div>
    </div>

    <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 shadow-lg mb-6 text-center relative overflow-hidden">
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-full h-1 bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.8)]"></div>
        
        <h2 class="text-gray-400 text-sm mb-4">åº•å±‚èµ„äº§ç†è®ºåº”å¾—æ€»å€¼ (R_total)</h2>
        <div class="text-5xl md:text-6xl font-bold text-emerald-400 neon-text tracking-wider">
            Â¥ {{ navData.R_total || '0.00' }}
        </div>
        
        <div class="mt-8 flex justify-center space-x-8 text-sm border-t border-gray-700 pt-4 max-w-md mx-auto">
            <span class="text-gray-400">æœ‰æ•ˆæœ¬é‡‘: <span class="text-white font-mono">Â¥{{ navData.effective_principal }}</span></span>
            <span class="text-gray-400">å·²ç”Ÿå¤åˆ©: <span class="text-emerald-400 font-mono">+Â¥{{ navData.total_compound_interest }}</span></span>
        </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 shadow-lg">
        <h3 class="text-gray-400 text-sm mb-4 flex items-center font-bold">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
            åº•å±‚èµ„äº§ç©¿é€æŠ¥å‘Š (èµ„é‡‘çœŸå®å»å‘)
        </h3>
        
        <div v-if="!allocations || allocations.length === 0" class="text-sm text-gray-500 py-2">
            ç›®å‰èµ„é‡‘å¤„äºå¤‡ä»˜é‡‘çŠ¶æ€ï¼ŒGP æš‚æœªè¿›è¡Œè·¨èµ„äº§å®è§‚é…ç½®ã€‚
        </div>
        
        <div v-else class="space-y-3">
            <div v-for="item in allocations" :key="item.asset" class="flex items-center justify-between text-sm bg-gray-900 p-3 rounded border border-gray-700">
                <span class="text-gray-300 font-bold">{{ item.asset }}</span>
                <div class="text-right">
                    <span class="text-yellow-500 font-mono">Â¥ {{ item.amount }}</span>
                    <span class="text-xs text-gray-500 ml-2">
                        ({{ navData.R_total > 0 ? ((item.amount / navData.R_total) * 100).toFixed(1) : 0 }}%)
                    </span>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4 border-t border-gray-700 pt-2">
            å£°æ˜ï¼šæ­¤æ¿å—å±•ç¤ºä½ è¢«æ‰˜ç®¡çš„èµ„é‡‘åœ¨ç‰©ç†ä¸–ç•Œçš„çœŸå®è¿ä½œè½¨è¿¹ï¼ˆå¦‚ï¼šä½™é¢å®ç”Ÿæ¯ã€ç¾è‚¡å¯¹å†²ç­‰ï¼‰ã€‚
        </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div class="border border-gray-700 rounded-lg p-6 bg-gray-900">
            <h3 class="text-lg text-red-400 font-bold mb-4">å‘èµ·é™åˆ¶æ€§èµå› (ä¹°ä¸œè¥¿)</h3>
            <form @submit.prevent="submitWithdrawal" class="space-y-4">
                <input v-model="form.amount" type="number" step="0.01" class="w-full bg-black border border-gray-700 rounded p-2 text-white" placeholder="ç”³è¯·é‡‘é¢" required>
                <textarea v-model="form.reason" class="w-full bg-black border border-gray-700 rounded p-2 text-white" placeholder="èµ„é‡‘ç”¨é€”è‡ªè¿°..." required></textarea>
                <button type="submit" class="bg-red-900/80 hover:bg-red-800 text-white font-bold py-2 px-4 rounded w-full border border-red-700 transition">æäº¤ T-3 å®¡æŸ¥</button>
            </form>
        </div>

        <div class="border border-gray-700 rounded-lg p-6 bg-gray-900">
            <h3 class="text-lg text-emerald-400 font-bold mb-4">æ­£å‘é˜¿å°”æ³•çº¢åˆ©è¡Œæƒ (ä¼ æˆç»©)</h3>
            <form @submit.prevent="submitAlpha" class="space-y-4">
                <input v-model="alphaForm.reason" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white" placeholder="è¾¾æ ‡è¯´æ˜(å¦‚: æœŸæœ«æ•°å­¦å¹´çº§å‰3%)" required>
                <input type="file" ref="fileInput" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-gray-700 file:text-white" required>
                <button type="submit" class="bg-emerald-800/80 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded w-full border border-emerald-600 transition">ä¸Šä¼ å‡­è¯ï¼Œç­‰å¾… GP è£å®šå¥–é‡‘</button>
            </form>
        </div>
    </div>

    <div class="mt-8 border border-gray-700 rounded-lg p-6 bg-gray-900 shadow-inner">
        <h3 class="text-lg text-blue-400 font-bold mb-4 flex items-center">å·¥å•è¿›åº¦è¿½è¸ª (æœ€è¿‘10æ¡)</h3>
        <div v-if="myRequests.length === 0" class="text-gray-500 text-sm py-4">æš‚æ— å†å²ç”³è¯·è®°å½•ã€‚</div>
        <div v-else class="space-y-3 overflow-y-auto pr-2">
            <div v-for="req in myRequests" :key="req.id" class="flex justify-between items-center bg-black p-3 rounded border border-gray-800">
                <div>
                    <span class="text-xs text-gray-500">{{ req.req_date }}</span>
                    <span class="ml-2 text-sm font-bold" :class="req.req_type === 'WITHDRAWAL_REQ' ? 'text-red-400' : 'text-emerald-400'">
                        {{ req.req_type === 'WITHDRAWAL_REQ' ? 'æµåŠ¨æ€§é‡Šæ”¾ (ææ¬¾)' : 'é˜¿å°”æ³•çº¢åˆ© (å¥–é‡‘)' }}
                    </span>
                    <div class="text-xs text-gray-400 mt-1">äº‹ç”±: {{ req.reason }}</div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-mono text-white">Â¥ {{ req.amount > 0 ? req.amount : 'ç­‰å¾…æ ¸å®š' }}</div>
                    <div class="text-xs font-bold mt-1 px-2 py-1 rounded inline-block"
                         :class="{
                            'bg-yellow-900/50 text-yellow-500 border border-yellow-700': req.status === 'PENDING',
                            'bg-emerald-900/50 text-emerald-500 border border-emerald-700': req.status === 'APPROVED',
                            'bg-red-900/50 text-red-500 border border-red-700': req.status === 'REJECTED'
                         }">
                        {{ req.status === 'PENDING' ? 'â³ å®¡æŸ¥ä¸­' : (req.status === 'APPROVED' ? 'âœ… å·²æ‰¹å‡†' : 'âŒ å·²é©³å›') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue
    createApp({
        setup() {
            const API_BASE = '/api/v1';
            const navData = ref({});
            const limitStatus = ref({ monthly_limit: 0, used_amount: 0, remaining: 0, can_claim_quarterly: false });
            const form = ref({ amount: '', reason: '' });
            const alphaForm = ref({ reason: '' });
            const myRequests = ref([]);
            const fileInput = ref(null);
            
            // ã€æ–°å¢ã€‘ç”¨æ¥æ¥æ”¶åå°ç©¿é€æ•°æ®çš„å˜é‡
            const allocations = ref([]);

            const fetchData = async () => {
                // åˆ·æ–°å‡€å€¼ä¸èµ„äº§å»å‘
                const navRes = await fetch(`${API_BASE}/dashboard`);
                const dashboardData = await navRes.json();
                navData.value = dashboardData.nav;
                allocations.value = dashboardData.allocations || []; // æ‹¿åˆ°åº•å±‚çš„èµ„äº§é…ç½®æ•°æ®

                // åˆ·æ–°é¢åº¦
                const limitRes = await fetch(`${API_BASE}/lp/limit_status`);
                limitStatus.value = await limitRes.json();
                
                // åˆ·æ–°å·¥å•åˆ—è¡¨
                const reqRes = await fetch(`${API_BASE}/lp/my_requests`);
                myRequests.value = await reqRes.json();
            };

            const submitWithdrawal = async () => {
                if (!confirm("è­¦å‘Šï¼šä»»ä½•æå‰æå–éƒ½ä¼šç›´æ¥æ‰£å‡ä½ çš„æœ‰æ•ˆæœ¬é‡‘ï¼Œå¯¼è‡´å¤åˆ©æ–­å´–å¼ä¸‹è·Œã€‚ä½ ç¡®å®šè¦æ”¾å¼ƒå»¶è¿Ÿæ»¡è¶³å—ï¼Ÿ")) return;
                
                const formData = new FormData();
                formData.append('amount', form.value.amount);
                formData.append('reason', form.value.reason);
                try {
                    const res = await fetch(`${API_BASE}/lp/request_withdrawal`, { method: 'POST', body: formData });
                    const result = await res.json();
                    if (!res.ok) alert(result.detail); else { alert(result.message); form.value = {amount:'', reason:''}; fetchData(); }
                } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
            };

            const submitAlpha = async () => {
                const formData = new FormData();
                formData.append('reason', alphaForm.value.reason);
                formData.append('file', fileInput.value.files[0]);
                try {
                    const res = await fetch(`${API_BASE}/lp/request_alpha`, { method: 'POST', body: formData });
                    alert((await res.json()).message);
                    alphaForm.value = {reason:''};
                    fileInput.value.value = null;
                    fetchData();
                } catch (e) { alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"); }
            };

            const claimQuarterly = async () => {
                if (!confirm("çœŸçš„è¦è½è¢‹ä¸ºå®‰å—ï¼Ÿå¦‚æœæŠŠè¿™30å…ƒç•™åœ¨æ± å­é‡Œï¼Œå®ƒä¼šé™ªç€ä½ çš„æœ¬é‡‘ä¸€èµ·å¤åˆ©å¢é•¿å“¦ï¼")) return;
                
                const res = await fetch(`${API_BASE}/lp/claim_quarterly`, { method: 'POST' });
                alert((await res.json()).message);
                fetchData();
            };

            onMounted(fetchData);
            return { navData, limitStatus, form, alphaForm, fileInput, myRequests, allocations, submitWithdrawal, submitAlpha, claimQuarterly }
        }
    }).mount('#app')
</script>
</body>
</html>