<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GP æ ¸å¿ƒæ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>body { background-color: #050505; color: #e5e5e5; } .gp-border { border-color: rgba(212, 175, 55, 0.5); }</style>
</head>
<body class="p-4 md:p-8 font-sans">
<div id="admin-app" class="max-w-7xl mx-auto space-y-6">
    <header class="border-b border-yellow-700/50 pb-4 flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-bold text-yellow-500 tracking-wider">GP å…¨æƒæ§åˆ¶å°</h1>
            <p class="text-sm text-gray-500 mt-2">å·²å¼€å¯å…¨å±€å¿ƒè·³ç›‘å¬ï¼šè‡ªåŠ¨åŒæ­¥å‰å°åŠ¨æ€ï¼Œå®æ—¶æŒ‡æŒ¥</p>
        </div>
        <div class="flex items-center">
            <span class="relative flex h-3 w-3 mr-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
            </span>
            <span class="text-xs text-emerald-500 font-mono">å®æ—¶åŒæ­¥ä¸­...</span>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-gray-900 p-6 rounded-lg border gp-border shadow-lg">
                <h2 class="text-xl font-bold text-yellow-500 mb-4">å¾…åŠå®¡æ‰¹è¯·æ±‚ ({{ pendingRequests.length }})</h2>
                <div v-if="pendingRequests.length === 0" class="text-gray-600 text-sm py-4 border border-dashed border-gray-700 rounded text-center">
                    æ‰€æœ‰å·¥å•å‡å·²å¤„ç†å®Œæ¯•ï¼Œç›®å‰å¤©ä¸‹å¤ªå¹³ã€‚
                </div>
                <div v-for="req in pendingRequests" :key="req.id" class="border border-gray-700 bg-black p-4 rounded-lg mb-4">
                    <p class="text-xs font-bold" :class="req.req_type === 'WITHDRAWAL_REQ' ? 'text-red-400' : 'text-emerald-400'">{{ req.req_type === 'WITHDRAWAL_REQ' ? 'âš ï¸ ææ¬¾è¯·æ±‚' : 'ğŸ“ˆ å¥–é‡‘è¡Œæƒ' }}</p>
                    <div class="flex justify-between items-start mt-2">
                        <div class="flex-1 mr-4">
                            <p class="text-lg text-white">é‡‘é¢: Â¥ {{ req.amount > 0 ? req.amount.toFixed(2) : 'ç­‰å¾… GP æ ¸å®š' }}</p>
                            <p class="text-sm text-gray-400">äº‹ç”±: {{ req.reason }}</p>
                            <a v-if="req.proof_image" :href="'/' + req.proof_image" target="_blank" class="text-blue-400 text-sm underline mt-2 inline-block">ğŸ‘‰ å®¡æŸ¥å‡­è¯</a>
                        </div>
                        <div class="flex flex-col space-y-2 w-56">
                            <input v-if="req.req_type === 'ALPHA_REQ'" v-model="req.final_amount" type="number" class="w-full bg-black border border-yellow-700 rounded p-1 text-white text-sm text-center focus:outline-none" placeholder="å¡«æ ¸å®šé‡‘é¢ (æ‰¹å‡†å¿…å¡«)">
                            <input v-model="req.reject_reason" type="text" class="w-full bg-gray-900 border border-red-800 rounded p-1 text-white text-sm text-center focus:outline-none focus:border-red-500" placeholder="é©³å›åŸå›  (é©³å›å¿…å¡«)">
                            
                            <div class="flex space-x-2">
                                <button @click="processRequest(req, false)" class="flex-1 bg-emerald-700 hover:bg-emerald-600 py-1 rounded text-sm font-bold transition">æ‰¹å‡†</button>
                                <button @click="processRequest(req, true)" class="flex-1 border border-red-700 text-red-500 hover:bg-red-900 py-1 rounded text-sm font-bold transition">é©³å›</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-gray-800 shadow-lg">
                <h2 class="text-lg font-bold text-gray-400 mb-4">åº•å±‚æ ¸å¿ƒè´¦æœ¬æµæ°´ (å®æ—¶)</h2>
                <div class="overflow-y-auto max-h-64 pr-2">
                    <table class="w-full text-sm text-left text-gray-400">
                        <tr v-for="tx in ledger" :key="tx.id" class="border-b border-gray-800 hover:bg-gray-800 transition">
                            <td class="py-2 px-2 whitespace-nowrap">{{ tx.tx_date }}</td>
                            <td class="py-2 px-2 font-bold" :class="{'text-purple-400': tx.tx_type.includes('ADJUST'), 'text-emerald-400': tx.tx_type.includes('PRINCIPAL') || tx.tx_type.includes('ALPHA'), 'text-red-400': tx.tx_type.includes('WITHDRAWAL')}">{{ tx.tx_type }}</td>
                            <td class="py-2 px-2 font-mono">Â¥ {{ tx.amount }}</td>
                            <td class="py-2 px-2 truncate max-w-xs">{{ tx.description }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-blue-900/50 shadow-lg">
                <h2 class="text-lg font-bold text-blue-400 mb-4">ğŸ’¬ ä¹™æ–¹ç•™è¨€æ¿ä¸å›å¤æ±  (å®æ—¶)</h2>
                <div class="space-y-4 max-h-80 overflow-y-auto pr-2">
                    <div v-for="msg in messages" :key="msg.id" class="bg-black p-4 rounded border border-gray-700 transition">
                        <div class="mb-2"><span class="text-gray-500 text-xs">{{ msg.created_date }}</span><p class="text-gray-200 mt-1"><span class="font-bold text-yellow-500">ä¹™æ–¹ï¼š</span>{{ msg.content }}</p></div>
                        <div v-if="msg.reply" class="pl-4 border-l-2 border-emerald-600 mt-3 bg-gray-900 py-2"><p class="text-emerald-400 text-sm">å·²å›å¤ï¼š{{ msg.reply }}</p></div>
                        <div v-else class="mt-4 flex space-x-2">
                            <input v-model="msg.draftReply" type="text" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="æ‰¹ç¤º...">
                            <button @click="replyMsg(msg)" class="bg-emerald-800 text-white px-4 py-1 rounded text-sm font-bold hover:bg-emerald-700 transition">å›å¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            
            <div class="bg-orange-900/20 p-6 rounded-lg border border-orange-500/50 shadow-[0_0_15px_rgba(249,115,22,0.15)]">
                <h2 class="font-bold text-orange-400 mb-2">ğŸ“¢ ç³»ç»Ÿé€šçŸ¥ä¸æ”¿ä»¤ç®¡ç†</h2>
                <form @submit.prevent="publishNotice" class="space-y-3 mb-4">
                    <textarea v-model="noticeForm" class="w-full bg-black border border-orange-700/50 rounded p-2 text-white text-sm focus:outline-none focus:border-orange-500" placeholder="å†™ä¸‹è¦å‘ä¹™æ–¹å®£å‘Šçš„å†…å®¹..." required rows="2"></textarea>
                    <button type="submit" class="w-full bg-orange-700 hover:bg-orange-600 py-2 rounded font-bold text-white transition tracking-widest shadow-lg shadow-orange-900/50">å…¨ç½‘å¹¿æ’­</button>
                </form>
                
                <div v-if="notices.length > 0" class="border-t border-orange-800/50 pt-4 space-y-2 max-h-40 overflow-y-auto pr-1">
                    <p class="text-xs text-orange-500/70 mb-2">å½“å‰æŒ‚åœ¨å‰å°çš„é€šçŸ¥ (è‡ªåŠ¨åŒæ­¥)ï¼š</p>
                    <div v-for="n in notices" :key="n.id" class="bg-black/50 p-2 rounded border border-orange-800/50 flex justify-between items-center group transition">
                        <div class="truncate mr-2 flex-1">
                            <p class="text-gray-300 text-xs truncate" :title="n.content">{{ n.content }}</p>
                            <p class="text-gray-600 text-[10px] mt-1">{{ n.publish_time }}</p>
                        </div>
                        <button @click="deleteNotice(n.id)" class="text-red-500 hover:text-white hover:bg-red-600 border border-red-800/50 hover:border-red-600 text-xs px-2 py-1 rounded transition">æ’¤å›</button>
                    </div>
                </div>
            </div>

            <div class="bg-purple-900/20 p-6 rounded-lg border border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.15)] relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-purple-600 text-xs font-bold px-2 py-1 rounded-bl text-white tracking-widest">GOD MODE</div>
                <h2 class="font-bold text-purple-400 mb-2">ä¸Šå¸æ¨¡å¼ï¼šèµ„é‡‘æ± å¼ºæ§</h2>
                <form @submit.prevent="adjustFunds" class="space-y-3 mt-4">
                    <div class="flex space-x-2">
                        <select v-model="adjustForm.action" class="w-1/3 bg-black border border-purple-700/50 rounded p-2 text-white font-bold focus:outline-none focus:border-purple-500" required>
                            <option value="UP">ğŸ“ˆ å¢åŠ </option>
                            <option value="DOWN">ğŸ“‰ æ‰£é™¤</option>
                        </select>
                        <input v-model="adjustForm.amount" type="number" step="0.01" class="w-2/3 bg-black border border-purple-700/50 rounded p-2 text-white font-mono focus:outline-none focus:border-purple-500" placeholder="é‡‘é¢" required>
                    </div>
                    <input v-model="adjustForm.description" type="text" class="w-full bg-black border border-purple-700/50 rounded p-2 text-white text-sm focus:outline-none focus:border-purple-500" placeholder="å¼ºæ§ç†ç”±" required>
                    <button type="submit" class="w-full bg-purple-700 hover:bg-purple-600 py-2 rounded font-bold text-white transition tracking-widest">æ‰§è¡Œè°ƒè´¦</button>
                </form>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border gp-border shadow-lg">
                <h2 class="font-bold text-yellow-500 mb-4">å¸¸è§„é€ å¸å±€</h2>
                <form @submit.prevent="injectFunds" class="space-y-3">
                    <select v-model="injectForm.tx_type" class="w-full bg-black border border-gray-700 rounded p-2 text-white"><option value="PRINCIPAL">æ³¨å…¥æ»šå­˜æœ¬é‡‘</option><option value="ALPHA">ç›´æ¥å‘æ”¾å¥–åŠ±</option></select>
                    <input v-model="injectForm.amount" type="number" step="0.01" class="w-full bg-black border border-gray-700 rounded p-2 text-white" placeholder="é‡‘é¢" required>
                    <input v-model="injectForm.description" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="æ³¨å…¥æ‘˜è¦" required>
                    <button type="submit" class="w-full bg-yellow-700 hover:bg-yellow-600 py-2 rounded font-bold text-white transition">æ­£è§„è·¯å¾„å…¥è´¦</button>
                </form>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 shadow-lg">
                <h2 class="font-bold text-gray-200 mb-2">ç©¿é€è°ƒä»“ç®¡ç†</h2>
                <div v-for="item in allocations" :key="item.asset" class="flex justify-between items-center text-sm bg-black p-2 rounded mb-2 border border-gray-800 transition">
                    <span class="text-gray-300">{{ item.asset }}</span>
                    <span class="text-yellow-500 font-mono">Â¥ {{ item.amount }}</span>
                </div>
                <form @submit.prevent="submitAllocation" class="space-y-3 mt-4 border-t border-gray-800 pt-3">
                    <input v-model="allocForm.asset" type="text" class="w-full bg-black border border-gray-600 rounded p-2 text-white text-sm" placeholder="æ ‡çš„åç§°" required>
                    <input v-model="allocForm.amount" type="number" step="0.01" class="w-full bg-black border border-gray-600 rounded p-2 text-white text-sm" placeholder="é‡‘é¢ (0ä¸ºæ¸…ä»“)" required>
                    <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded text-white font-bold transition">å‘é€å¯¹å†²æŒ‡ä»¤</button>
                </form>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-blue-900/50 shadow-lg relative overflow-hidden">
                <div v-if="quarterlyInfo.status === 'ACTIVE'" class="absolute top-0 left-0 w-full h-1 bg-yellow-500 animate-pulse"></div>
                <h2 class="text-lg font-bold text-blue-400 mb-4">é›·è¾¾ï¼šæ³•å®šæ´¾æ¯ (72h é™æ—¶)</h2>
                <div class="bg-black p-4 rounded border border-gray-800 mb-4">
                    <div v-if="quarterlyInfo.status === 'INACTIVE'" class="text-gray-400 font-bold text-sm">ç³»ç»Ÿé™é»˜ï¼Œæš‚æ— æ´¾æ¯è¿½è¸ªã€‚</div>
                    <div v-if="quarterlyInfo.status === 'ACTIVE'" class="text-yellow-500 font-bold text-sm tracking-wide">
                        â³ ä¹™æ–¹å°šæœªæå–ï¼<br><span class="text-2xl mt-1 block font-mono">å€’è®¡æ—¶: {{ quarterlyInfo.hours_left }}h</span>
                    </div>
                    <div v-if="quarterlyInfo.status === 'CLAIMED'" class="text-emerald-500 font-bold text-sm">âœ… èµ„é‡‘å·²æµå‡ºï¼æå–æ—¶é—´ï¼š{{ quarterlyInfo.claimed_at }}</div>
                    <div v-if="quarterlyInfo.status === 'EXPIRED'" class="text-red-500 font-bold text-sm">âŒ ç‹©çŒå¤±è´¥ï¼Œèµ„é‡‘å·²è‡ªåŠ¨ä½œåºŸå……å…¬ã€‚</div>
                </div>
                <button @click="toggleQuarterly" class="w-full bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded text-sm transition">
                    é‡æ–°å‘å¸ƒ 30å…ƒ æ´¾æ¯ä»¤
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue
    createApp({
        setup() {
            const API_BASE = '/api/v1';
            const pendingRequests = ref([]);
            const messages = ref([]);
            const ledger = ref([]);
            const allocations = ref([]); 
            const quarterlyInfo = ref({}); 
            const notices = ref([]); 
            
            const injectForm = ref({ tx_type: 'PRINCIPAL', amount: '', description: '' });
            const allocForm = ref({ asset: '', amount: '' }); 
            const adjustForm = ref({ action: 'UP', amount: '', description: '' }); 
            const noticeForm = ref('');

            // ğŸ‘‰ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨æŠ“å–æ–°æ•°æ®æ—¶ï¼ŒæŠŠæ—§æ•°æ®æ¡†é‡Œè¿˜æ²¡æäº¤çš„æ‰“å­—è‰ç¨¿æå–å‡ºæ¥ï¼Œåˆå¹¶è¿›å»ï¼
            const fetchData = async () => {
                const t = new Date().getTime(); 
                try {
                    // 1. æŠ“å–å®¡æ‰¹å·¥å•ï¼ˆä¿æŠ¤æ‰“å­—è‰ç¨¿ï¼‰
                    const newRequests = await (await fetch(`${API_BASE}/gp/pending_requests?t=${t}`)).json();
                    pendingRequests.value = newRequests.map(newReq => {
                        const oldReq = pendingRequests.value.find(r => r.id === newReq.id);
                        if (oldReq) {
                            newReq.final_amount = oldReq.final_amount; // ä¿ç•™å¡«å†™çš„æ ¸å®šé‡‘é¢
                            newReq.reject_reason = oldReq.reject_reason; // ä¿ç•™å¡«å†™çš„é©³å›åŸå› 
                        }
                        return newReq;
                    });

                    // 2. æŠ“å–ç•™è¨€åˆ—è¡¨ï¼ˆä¿æŠ¤å›å¤è‰ç¨¿ï¼‰
                    const newMessages = await (await fetch(`${API_BASE}/messages?t=${t}`)).json();
                    messages.value = newMessages.map(newMsg => {
                        const oldMsg = messages.value.find(m => m.id === newMsg.id);
                        if (oldMsg) {
                            newMsg.draftReply = oldMsg.draftReply; // ä¿ç•™å¡«å†™çš„å›å¤å†…å®¹
                        }
                        return newMsg;
                    });

                    // 3. å…¶ä»–çº¯å±•ç¤ºæ•°æ®ï¼Œç›´æ¥åˆ·æ–°
                    const dashData = await (await fetch(`${API_BASE}/dashboard?t=${t}`)).json();
                    ledger.value = dashData.ledger;
                    allocations.value = dashData.allocations || [];
                    quarterlyInfo.value = dashData.quarterly_info; 
                    notices.value = await (await fetch(`${API_BASE}/lp/notices?t=${t}`)).json(); 
                } catch(e) { console.log("æ‹‰å–æ›´æ–°å¤±è´¥"); }
            };

            const processRequest = async (req, isReject) => {
                const action = isReject ? 'REJECT' : 'APPROVE';
                let final_amount = 0;
                if (action === 'APPROVE' && req.req_type === 'ALPHA_REQ') {
                    if (!req.final_amount) { alert("ğŸš¨ æ‰¹å‡†å¥–é‡‘å‰ï¼Œè¯·åŠ¡å¿…å¡«å†™æ‚¨æ ¸å®šçš„å…·ä½“é‡‘é¢ï¼"); return; }
                    final_amount = req.final_amount;
                }
                if (action === 'REJECT') {
                    if (!req.reject_reason || req.reject_reason.trim() === "") {
                        alert("ğŸš¨ æ—¢ç„¶é©³å›ï¼Œå°±å¿…é¡»è®©ä¹™æ–¹æ­»ä¸ªæ˜ç™½ã€‚è¯·å¡«å†™é©³å›åŸå› ï¼"); return;
                    }
                }
                if(!confirm(`ç¡®å®šè¦ ${isReject ? 'é©³å›' : 'æ‰¹å‡†'} è¿™ç¬”å·¥å•å—ï¼Ÿ`)) return;
                
                const res = await fetch(`${API_BASE}/gp/process_request/${req.id}?action=${action}&final_amount=${final_amount}&reject_reason=${encodeURIComponent(req.reject_reason || '')}`, { method: 'POST' });
                if(res.ok) alert((await res.json()).message);
                fetchData();
            };

            const publishNotice = async () => {
                if(!confirm("å‘é€åä¹™æ–¹å°†åœ¨å‰å°ç½®é¡¶çœ‹åˆ°æ­¤é€šçŸ¥ï¼Œç¡®å®šå¹¿æ’­å—ï¼Ÿ")) return;
                const fd = new FormData(); fd.append('content', noticeForm.value);
                const res = await fetch(`${API_BASE}/gp/notices`, { method: 'POST', body: fd });
                if(res.ok) {
                    alert((await res.json()).message);
                    noticeForm.value = '';
                    fetchData(); 
                }
            };

            const deleteNotice = async (id) => {
                if(!confirm("ç¡®å®šè¦æ’¤å›è¿™æ¡æ”¿ä»¤å—ï¼Ÿæ’¤å›åï¼Œä¹™æ–¹å‰å°å°†ç«‹å³æ¶ˆå¤±ï¼")) return;
                const res = await fetch(`${API_BASE}/gp/notices/${id}`, { method: 'DELETE' });
                if(res.ok) { alert((await res.json()).message); fetchData(); }
            };

            const injectFunds = async () => {
                if(!confirm("ç¡®è®¤æ³¨å…¥èµ„é‡‘ï¼Ÿ")) return;
                const fd = new FormData(); fd.append('tx_type', injectForm.value.tx_type); fd.append('amount', injectForm.value.amount); fd.append('description', injectForm.value.description);
                const res = await fetch(`${API_BASE}/gp/inject_funds`, { method: 'POST', body: fd });
                alert((await res.json()).message); injectForm.value = { tx_type: 'PRINCIPAL', amount: '', description: '' }; fetchData();
            };

            const adjustFunds = async () => {
                const actionText = adjustForm.value.action === 'UP' ? 'å¢åŠ ' : 'æ‰£é™¤';
                if(!confirm(`ç¡®å®šã€${actionText}ã€‘ Â¥${adjustForm.value.amount} å—ï¼Ÿ`)) return;
                const fd = new FormData(); fd.append('action', adjustForm.value.action); fd.append('amount', adjustForm.value.amount); fd.append('description', adjustForm.value.description);
                const res = await fetch(`${API_BASE}/gp/adjust_funds`, { method: 'POST', body: fd });
                if(res.ok) { alert((await res.json()).message); adjustForm.value = { action: 'UP', amount: '', description: '' }; fetchData(); } 
                else alert((await res.json()).detail);
            };

            const submitAllocation = async () => {
                const fd = new FormData(); fd.append('asset_name', allocForm.value.asset); fd.append('amount', allocForm.value.amount);
                const res = await fetch(`${API_BASE}/gp/asset_allocation`, { method: 'POST', body: fd });
                if (!res.ok) alert((await res.json()).detail); else { alert((await res.json()).message); allocForm.value = { asset: '', amount: '' }; fetchData(); }
            };

            const toggleQuarterly = async () => {
                if(!confirm("ç¡®å®šç°åœ¨æ”¾å‡ºæ´¾æ¯ä»¤å¹¶å¼€å¯å€’è®¡æ—¶å—ï¼Ÿ")) return;
                const res = await fetch(`${API_BASE}/gp/toggle_quarterly`, { method: 'POST' }); alert((await res.json()).message); fetchData();
            };

            const replyMsg = async (msg) => {
                if (!msg.draftReply) return;
                const fd = new FormData(); fd.append('reply', msg.draftReply);
                const res = await fetch(`${API_BASE}/gp/messages/${msg.id}/reply`, { method: 'POST', body: fd });
                if(res.ok) { alert("å›å¤å·²å‘é€ç»™ä¹™æ–¹ã€‚"); fetchData(); }
            };

            onMounted(() => { 
                fetchData(); 
                setInterval(fetchData, 3000);
            });
            return { pendingRequests, messages, ledger, allocations, quarterlyInfo, notices, injectForm, allocForm, adjustForm, noticeForm, processRequest, publishNotice, deleteNotice, injectFunds, adjustFunds, submitAllocation, toggleQuarterly, replyMsg }
        }
    }).mount('#admin-app')
</script>
</body>
</html>