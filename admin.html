<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GP æ ¸å¿ƒæ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>body { background-color: #050505; color: #e5e5e5; } .gp-border { border-color: rgba(212, 175, 55, 0.5); }</style>
</head>
<body class="p-4 md:p-8 font-sans">
<div id="admin-app" class="max-w-7xl mx-auto space-y-6">
    <header class="border-b border-yellow-700/50 pb-4">
        <h1 class="text-3xl font-bold text-yellow-500 tracking-wider">GP å…¨æƒæ§åˆ¶å°</h1>
        <p class="text-sm text-gray-500 mt-2">æ‹¥æœ‰ç»å¯¹æ§åˆ¶æƒï¼šå®¡æ‰¹æµã€èµ„é‡‘æ³¨é”€ã€èµ„äº§ç©¿é€ä¸è·¨æ—¶ç©ºè°ƒè´¦</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-gray-900 p-6 rounded-lg border gp-border shadow-lg">
                <h2 class="text-xl font-bold text-yellow-500 mb-4">å¾…åŠå®¡æ‰¹è¯·æ±‚ ({{ pendingRequests.length }})</h2>
                <div v-if="pendingRequests.length === 0" class="text-gray-600 text-sm py-4 border border-dashed border-gray-700 rounded text-center">
                    æ‰€æœ‰å·¥å•å‡å·²å¤„ç†å®Œæ¯•ï¼Œç›®å‰å¤©ä¸‹å¤ªå¹³ã€‚
                </div>
                <div v-for="req in pendingRequests" :key="req.id" class="border border-gray-700 bg-black p-4 rounded-lg mb-4">
                    <p class="text-xs font-bold" :class="req.req_type === 'WITHDRAWAL_REQ' ? 'text-red-400' : 'text-emerald-400'">{{ req.req_type === 'WITHDRAWAL_REQ' ? 'âš ï¸ ææ¬¾è¯·æ±‚' : 'ğŸ“ˆ å¥–é‡‘è¡Œæƒ' }}</p>
                    <div class="flex justify-between items-center mt-2">
                        <div>
                            <p class="text-lg text-white">é‡‘é¢: Â¥ {{ req.amount > 0 ? req.amount.toFixed(2) : 'ç­‰å¾… GP æ ¸å®š' }}</p>
                            <p class="text-sm text-gray-400">äº‹ç”±: {{ req.reason }}</p>
                            <a v-if="req.proof_image" :href="'http://127.0.0.1:8000/' + req.proof_image" target="_blank" class="text-blue-400 text-sm underline mt-2 inline-block">ğŸ‘‰ å®¡æŸ¥å‡­è¯</a>
                        </div>
                        <div class="flex flex-col space-y-2 w-32">
                            <input v-if="req.req_type === 'ALPHA_REQ'" v-model="req.final_amount" type="number" class="w-full bg-black border border-yellow-700 rounded p-1 text-white text-sm text-center" placeholder="å¡«æ ¸å®šé‡‘é¢">
                            <button @click="processRequest(req, false)" class="bg-emerald-700 hover:bg-emerald-600 px-4 py-1 rounded text-sm font-bold transition">æ‰¹å‡†</button>
                            <button @click="processRequest(req, true)" class="border border-red-700 text-red-500 hover:bg-red-900 px-4 py-1 rounded text-sm font-bold transition">é©³å›</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-gray-800 shadow-lg">
                <h2 class="text-lg font-bold text-gray-400 mb-4">åº•å±‚æ ¸å¿ƒè´¦æœ¬æµæ°´ (å«ä¸Šå¸å¼ºæ§è®°å½•)</h2>
                <div class="overflow-y-auto max-h-64 pr-2">
                    <table class="w-full text-sm text-left text-gray-400">
                        <tr v-for="tx in ledger" :key="tx.id" class="border-b border-gray-800 hover:bg-gray-800">
                            <td class="py-2 px-2 whitespace-nowrap">{{ tx.tx_date }}</td>
                            <td class="py-2 px-2 font-bold" :class="{'text-purple-400': tx.tx_type.includes('ADJUST'), 'text-emerald-400': tx.tx_type.includes('PRINCIPAL') || tx.tx_type.includes('ALPHA'), 'text-red-400': tx.tx_type.includes('WITHDRAWAL')}">{{ tx.tx_type }}</td>
                            <td class="py-2 px-2 font-mono">Â¥ {{ tx.amount }}</td>
                            <td class="py-2 px-2 truncate max-w-xs">{{ tx.description }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-blue-900/50 shadow-lg">
                <h2 class="text-lg font-bold text-blue-400 mb-4">ğŸ’¬ ä¹™æ–¹ç•™è¨€æ¿ä¸å›å¤æ± </h2>
                <div class="space-y-4 max-h-80 overflow-y-auto pr-2">
                    <div v-for="msg in messages" :key="msg.id" class="bg-black p-4 rounded border border-gray-700">
                        <div class="mb-2"><span class="text-gray-500 text-xs">{{ msg.created_date }}</span><p class="text-gray-200 mt-1"><span class="font-bold text-yellow-500">ä¹™æ–¹ï¼š</span>{{ msg.content }}</p></div>
                        <div v-if="msg.reply" class="pl-4 border-l-2 border-emerald-600 mt-3 bg-gray-900 py-2"><p class="text-emerald-400 text-sm">å·²å›å¤ï¼š{{ msg.reply }}</p></div>
                        <div v-else class="mt-4 flex space-x-2">
                            <input v-model="msg.draftReply" type="text" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white" placeholder="æ‰¹ç¤º...">
                            <button @click="replyMsg(msg)" class="bg-emerald-800 text-white px-4 py-1 rounded text-sm font-bold hover:bg-emerald-700 transition">å›å¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            
            <div class="bg-purple-900/20 p-6 rounded-lg border border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.15)] relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-purple-600 text-xs font-bold px-2 py-1 rounded-bl text-white tracking-widest">GOD MODE</div>
                <h2 class="font-bold text-purple-400 mb-2">ä¸Šå¸æ¨¡å¼ï¼šèµ„é‡‘æ± å¼ºæ§</h2>
                <p class="text-xs text-gray-500 mb-4">æ— éœ€ç»è¿‡ä¹™æ–¹çš„å¸¸è§„æµç¨‹ï¼Œå¼ºè¡Œå¹³è´¦ã€æƒ©ç½šæ‰£æ¬¾æˆ–æ— æ„ŸåŠ é’±ã€‚</p>
                <form @submit.prevent="adjustFunds" class="space-y-3">
                    <div class="flex space-x-2">
                        <select v-model="adjustForm.action" class="w-1/3 bg-black border border-purple-700/50 rounded p-2 text-white font-bold focus:outline-none focus:border-purple-500" required>
                            <option value="UP">ğŸ“ˆ å¼ºè¡Œå¢åŠ </option>
                            <option value="DOWN">ğŸ“‰ å¼ºè¡Œæ‰£é™¤</option>
                        </select>
                        <input v-model="adjustForm.amount" type="number" step="0.01" class="w-2/3 bg-black border border-purple-700/50 rounded p-2 text-white font-mono focus:outline-none focus:border-purple-500" placeholder="é‡‘é¢ (ä¸ç”¨å¡«è´Ÿå·)" required>
                    </div>
                    <input v-model="adjustForm.description" type="text" class="w-full bg-black border border-purple-700/50 rounded p-2 text-white text-sm focus:outline-none focus:border-purple-500" placeholder="å¼ºæ§ç†ç”± (å¿…å¡«ï¼Œä¼šå†™å…¥æµæ°´)" required>
                    <button type="submit" class="w-full bg-purple-700 hover:bg-purple-600 py-2 rounded font-bold text-white transition tracking-widest shadow-lg shadow-purple-900/50">æ‰§è¡Œå¼ºè°ƒ</button>
                </form>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border gp-border shadow-lg">
                <h2 class="font-bold text-yellow-500 mb-4">å¸¸è§„é€ å¸å±€ (æœ¬é‡‘/çº¢åˆ©)</h2>
                <form @submit.prevent="injectFunds" class="space-y-3">
                    <select v-model="injectForm.tx_type" class="w-full bg-black border border-gray-700 rounded p-2 text-white"><option value="PRINCIPAL">æ³¨å…¥æ»šå­˜æœ¬é‡‘</option><option value="ALPHA">ç›´æ¥å‘æ”¾å¥–åŠ±</option></select>
                    <input v-model="injectForm.amount" type="number" step="0.01" class="w-full bg-black border border-gray-700 rounded p-2 text-white" placeholder="é‡‘é¢" required>
                    <input v-model="injectForm.description" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="æ³¨å…¥æ‘˜è¦" required>
                    <button type="submit" class="w-full bg-yellow-700 hover:bg-yellow-600 py-2 rounded font-bold text-white transition">æ­£è§„è·¯å¾„å…¥è´¦</button>
                </form>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 shadow-lg">
                <h2 class="font-bold text-gray-200 mb-2">ç©¿é€è°ƒä»“ç®¡ç†</h2>
                <div v-for="item in allocations" :key="item.asset" class="flex justify-between text-sm bg-black p-2 rounded mb-2 border border-gray-800"><span class="text-gray-300">{{ item.asset }}</span><span class="text-yellow-500 font-mono">Â¥ {{ item.amount }}</span></div>
                <form @submit.prevent="submitAllocation" class="space-y-3 mt-4 border-t border-gray-800 pt-3">
                    <input v-model="allocForm.asset" type="text" class="w-full bg-black border border-gray-600 rounded p-2 text-white text-sm" placeholder="æ ‡çš„åç§°" required>
                    <input v-model="allocForm.amount" type="number" step="0.01" class="w-full bg-black border border-gray-600 rounded p-2 text-white text-sm" placeholder="é‡‘é¢(å¡«0ä¸ºæ¸…ä»“)" required>
                    <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded text-white font-bold border border-gray-600 transition">å‘é€å¯¹å†²æŒ‡ä»¤</button>
                </form>
            </div>

            <div class="bg-gray-900 p-6 rounded-lg border border-blue-900/50 shadow-lg relative overflow-hidden">
                <div v-if="quarterlyInfo.status === 'ACTIVE'" class="absolute top-0 left-0 w-full h-1 bg-yellow-500 animate-pulse"></div>
                <h2 class="text-lg font-bold text-blue-400 mb-4">é›·è¾¾ï¼šæ³•å®šæ´¾æ¯ (72h é™æ—¶)</h2>
                
                <div class="bg-black p-4 rounded border border-gray-800 mb-4">
                    <div v-if="quarterlyInfo.status === 'INACTIVE'" class="text-gray-400 font-bold text-sm">ç³»ç»Ÿé™é»˜ï¼Œæš‚æ— æ´¾æ¯è¿½è¸ªã€‚</div>
                    <div v-if="quarterlyInfo.status === 'ACTIVE'" class="text-yellow-500 font-bold text-sm tracking-wide">
                        â³ ä¹™æ–¹å°šæœªæå–ï¼<br><span class="text-2xl mt-1 block font-mono">å€’è®¡æ—¶: {{ quarterlyInfo.hours_left }}h</span>
                    </div>
                    <div v-if="quarterlyInfo.status === 'CLAIMED'" class="text-emerald-500 font-bold text-sm">
                        âœ… èµ„é‡‘å·²æµå‡ºï¼æå–æ—¶é—´ï¼š{{ quarterlyInfo.claimed_at }}
                    </div>
                    <div v-if="quarterlyInfo.status === 'EXPIRED'" class="text-red-500 font-bold text-sm">
                        âŒ ç‹©çŒå¤±è´¥ï¼Œèµ„é‡‘å·²è‡ªåŠ¨ä½œåºŸå……å…¬ã€‚
                    </div>
                </div>
                <button @click="toggleQuarterly" class="w-full bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded text-sm transition">
                    é‡æ–°å‘å¸ƒ 30å…ƒ æ´¾æ¯ä»¤
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue
    createApp({
        setup() {
            const API_BASE = '/api/v1';
            const pendingRequests = ref([]);
            const messages = ref([]);
            const ledger = ref([]);
            const allocations = ref([]); 
            const quarterlyInfo = ref({}); 
            
            const injectForm = ref({ tx_type: 'PRINCIPAL', amount: '', description: '' });
            const allocForm = ref({ asset: '', amount: '' }); 
            const adjustForm = ref({ action: 'UP', amount: '', description: '' }); // ğŸ‘‰ ä¸Šå¸è°ƒè´¦è¡¨å•

            const fetchData = async () => {
                pendingRequests.value = await (await fetch(`${API_BASE}/gp/pending_requests`)).json();
                messages.value = await (await fetch(`${API_BASE}/messages`)).json();
                const dashData = await (await fetch(`${API_BASE}/dashboard`)).json();
                ledger.value = dashData.ledger;
                allocations.value = dashData.allocations || [];
                quarterlyInfo.value = dashData.quarterly_info; 
            };

            const processRequest = async (req, isReject) => {
                const action = isReject ? 'REJECT' : 'APPROVE';
                let final_amount = 0;
                if (action === 'APPROVE' && req.req_type === 'ALPHA_REQ') {
                    if (!req.final_amount) { alert("ğŸš¨ è¯·å…ˆå¡«å†™æ‚¨æ ¸å®šçš„å¥–åŠ±é‡‘é¢ï¼"); return; }
                    final_amount = req.final_amount;
                }
                if(!confirm(`ç¡®å®šè¦ ${isReject ? 'é©³å›' : 'æ‰¹å‡†'} è¿™ç¬”å·¥å•å—ï¼Ÿ`)) return;
                
                const res = await fetch(`${API_BASE}/gp/process_request/${req.id}?action=${action}&final_amount=${final_amount}`, { method: 'POST' });
                alert((await res.json()).message);
                fetchData();
            };

            const injectFunds = async () => {
                if(!confirm("ç¡®è®¤è¦æŒ‰å¸¸è§„æµç¨‹æ³¨å…¥èµ„é‡‘å—ï¼Ÿè¿™ä¼šè¢«ç®—å…¥æœ¬é‡‘æˆ–çº¢åˆ©è¿›è¡Œå¤åˆ©è®¡ç®—ã€‚")) return;
                const fd = new FormData(); fd.append('tx_type', injectForm.value.tx_type); fd.append('amount', injectForm.value.amount); fd.append('description', injectForm.value.description);
                const res = await fetch(`${API_BASE}/gp/inject_funds`, { method: 'POST', body: fd });
                alert((await res.json()).message); // ğŸ‘‰ åŠ ä¸Šäº†å¼¹çª—æç¤ºï¼
                injectForm.value = { tx_type: 'PRINCIPAL', amount: '', description: '' };
                fetchData();
            };

            // ğŸ‘‰ ä¸Šå¸è§†è§’å¼ºæ§çš„æ–¹æ³•
            const adjustFunds = async () => {
                const actionText = adjustForm.value.action === 'UP' ? 'å¢åŠ ' : 'æ‰£é™¤';
                if(!confirm(`âš ï¸ è­¦å‘Šï¼šè¿™æ˜¯ä¸Šå¸æ¨¡å¼å¼ºæ§ï¼\næ‚¨ç¡®å®šè¦å¼ºè¡Œä»æ€»èµ„é‡‘æ± ä¸­ã€${actionText}ã€‘ Â¥${adjustForm.value.amount} å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯é€†ï¼Œå°†ç›´æ¥å½±å“ä¹™æ–¹çœ‹åˆ°çš„æ€»é¢ã€‚`)) return;
                
                const fd = new FormData(); fd.append('action', adjustForm.value.action); fd.append('amount', adjustForm.value.amount); fd.append('description', adjustForm.value.description);
                const res = await fetch(`${API_BASE}/gp/adjust_funds`, { method: 'POST', body: fd });
                if(res.ok) {
                    alert((await res.json()).message);
                    adjustForm.value = { action: 'UP', amount: '', description: '' };
                    fetchData();
                } else alert((await res.json()).detail);
            };

            const submitAllocation = async () => {
                const fd = new FormData(); fd.append('asset_name', allocForm.value.asset); fd.append('amount', allocForm.value.amount);
                try {
                    const res = await fetch(`${API_BASE}/gp/asset_allocation`, { method: 'POST', body: fd });
                    if (!res.ok) alert((await res.json()).detail); 
                    else { alert((await res.json()).message); allocForm.value = { asset: '', amount: '' }; fetchData(); }
                } catch (e) {}
            };

            const toggleQuarterly = async () => {
                if(!confirm("ç¡®å®šç°åœ¨å°±æ”¾å‡ºè¯±é¥µï¼ˆæ´¾æ¯ä»¤ï¼‰å¹¶å¼€å¯ 72å°æ—¶ æ­»äº¡å€’è®¡æ—¶å—ï¼Ÿ")) return;
                const res = await fetch(`${API_BASE}/gp/toggle_quarterly`, { method: 'POST' });
                alert((await res.json()).message);
                fetchData();
            };

            const replyMsg = async (msg) => {
                if (!msg.draftReply) return;
                const fd = new FormData(); fd.append('reply', msg.draftReply);
                const res = await fetch(`${API_BASE}/gp/messages/${msg.id}/reply`, { method: 'POST', body: fd });
                if(res.ok) { alert("å›å¤å·²å‘é€ç»™ä¹™æ–¹ã€‚"); fetchData(); }
            };

            onMounted(fetchData);
            return { pendingRequests, messages, ledger, allocations, quarterlyInfo, injectForm, allocForm, adjustForm, processRequest, injectFunds, adjustFunds, submitAllocation, toggleQuarterly, replyMsg }
        }
    }).mount('#admin-app')
</script>
</body>
</html>